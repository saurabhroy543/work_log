{% extends 'main_admin/base.html' %}
{% load static %}

{% block title %}
Blog
{% endblock %}

{% block body %}

<div class="content-wrapper">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0 text-dark">Blog</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/main_admin_dashboard">Home</a></li>
                        <li class="breadcrumb-item active">Blog</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header" style="background-color: #007bff; color:white;">
                            <h3 class="card-title">Blog</h3>
                        </div>
                        <div class="card-body">

                            {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert">
                                <strong>Message:</strong> {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            {% endfor %}

                            <div class="mb-3">
                                <button type="button" class="btn btn-primary btn-md float-left"
                                        data-toggle="modal" data-target="#Add-Model">
                                    <i class="fa fa-plus">&nbsp;</i> Add Blog
                                </button>
                            </div>
                            <br><br>

                            <div class="table-responsive">
                                <table class="table table-bordered table-striped" id="example1">
                                    <thead>
                                    <tr>
                                        <th>Banner Image</th>
                                        <th>Author</th>
                                        <th>Blog Type</th>
                                        <th>Blog Name</th>
                                        <th>Is Approve</th>
                                        <th>Admin User</th>
                                        <th>Create date</th>


                                        <th>Action</th>
                                    </tr>
                                    </thead>

                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Modal -->
        <div class="modal fade" id="Add-Model">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Add Blog</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form method="post" action="/add_blog" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label>Blog Name</label><strong style="color:red;">*</strong>
                                    <input type="text" name="add_blogname" class="form-control"
                                           id="add_blogname" placeholder="Enter Blog Name" required>
                                </div>
                                <div class="form-group col-md-6">
                                    <label>Blog Type</label><strong style="color:red;">*</strong>
                                    <select class="select2" name="add_blogtype" id="add_blogtype"
                                            data-placeholder="Select Blog type" style="width: 100%;" required>
                                        <option value="" selected disabled></option>
                                        {% for i in all_blog_type %}
                                        <option value="{{ i.id }}">{{ i.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">

                                <div class="form-group col-md-12">
                                    <label>Blog Author</label><strong style="color:red;">*</strong>
                                    <select class="select2" name="add_blogauthor" id="add_blogauthor"
                                            data-placeholder="Select Blog Author" style="width: 100%;" required>
                                        <option value="" selected disabled></option>
                                        {% for i in all_author %}
                                        <option value="{{ i.id }}">{{ i.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label>Banner Image</label><strong style="color:red;">*</strong>
                                    <input type="file" name="add_bannerimage" class="form-control"
                                           id="add_bannerimage" placeholder="Banner Image" required>
                                </div>
                                <div class="form-group col-md-6">
                                    <label>Description Image</label><strong style="color:red;">*</strong>
                                    <input type="file" name="add_decriptionimage" class="form-control"
                                           id="add_decriptionimage" placeholder="Description Image" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-12">
                                    <label>Blog Description</label><strong style="color:red;">*</strong>
                                    <p><b>Note:</b> Please enter only text in "\n" separate formate.
                                        i.e. title1 \n title2 \n title3</p>
                                    <textarea id="add_blogdesc" name="add_blogdesc" rows="6" cols="80"
                                              class="form-control"
                                              placeholder="Enter Blog Description" required="required"></textarea>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-danger" data-dismiss="modal">Close
                            </button>
                            <button type="submit" class="btn btn-primary">Create</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div class="modal fade" id="Edit-Model">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Edit Blog</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form method="post" action="/edit_blog" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label>Blog Name</label><strong style="color:red;">*</strong>
                                    <!-- hidden id -->
                                    <input type="hidden" name="edit_id" id="edit_id">
                                    <input type="text" name="edit_blogname" class="form-control"
                                           id="edit_blogname" placeholder="Enter Blog name" required>
                                </div>
                                <div class="form-group col-md-6">
                                    <label>Blog Type</label><strong style="color:red;">*</strong>
                                    <select class="select2" name="edit_blogtype" id="edit_blogtype"
                                            data-placeholder="Select blog type" style="width: 100%;" required>
                                        <option value="" selected disabled></option>
                                        {% for i in all_blog_type %}
                                        <option value="{{ i.id }}">{{ i.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>


                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-12">
                                    <label>Blog Author</label><strong style="color:red;">*</strong>
                                    <select class="select2" name="edit_blogauthor" id="edit_blogauthor"
                                            data-placeholder="Select author" style="width: 100%;" required>
                                        <option value="" selected disabled></option>
                                        {% for i in all_author %}
                                        <option value="{{ i.id }}">{{ i.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label>Banner Image</label><strong style="color:red;"></strong>
                                    <input type="file" name="edit_bannerimage" class="form-control"
                                           id="edit_bannerimage" placeholder="Banner Image">
                                </div>
                                <div class="form-group col-md-6">
                                    <label>Description Image</label><strong style="color:red;"></strong>
                                    <input type="file" name="edit_decriptionimage" class="form-control"
                                           id="edit_decriptionimage" placeholder="Description Image">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-12">
                                    <label>Blog Description</label><strong style="color:red;">*</strong>
                                    <p><b>Note:</b> Please enter only text in "\n" separate formate.
                                        i.e. title1 \n title2 \n title3</p>
                                    <textarea id="edit_blogdesc" name="edit_blogdesc" rows="6" cols="80"
                                              class="form-control"
                                              placeholder="Enter Blog Description" required="required"></textarea>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-danger" data-dismiss="modal">Close
                            </button>
                            <button type="submit" class="btn btn-primary">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete Modal -->
        <div class="modal fade" id="Delete-Model">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="post" action="/delete_blog" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h4 class="modal-title">Delete <i class="fa fa-trash"></i></h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this record <i class="fa fa-question-circle"></i></p>
                        </div>
                        <div class="modal-footer">
                            <input type="number" id="delete_id" name="delete_id" hidden>
                            <button type="submit" class="btn btn-danger" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Delete</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Approve-Disapprove Modal -->
        <div class="modal fade" id="Approve-Disapprove-Model">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="post" id="approve_disapprove">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h4 class="modal-title">Approve | Disapprove</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to approve this record <i class="fa fa-question-circle"></i>
                            </p>
                        </div>
                        <div class="modal-footer">
                            <input type="hidden" id="approve_disapprove_id" name="approve_disapprove_id">
                            <input type="hidden" id="approve_disapprove_tag"
                                   name="approve_disapprove_tag">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="submit" class="btn btn-danger" data-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </section>
</div>
{% endblock %}

{% block jquery %}

<!-- Datatable functionality -->
<script>
    document.getElementById("blog_list").className = "nav-item has-treeview menu-open";
    document.getElementById("blog_title").className = "nav-link active";
    document.getElementById("blog").className = "nav-link active";

    $('.select2').select2();

    // -------- dataTable Ajax processing START -----------
    $(document).ready(function () {
        $('#example1').dataTable({
            "ordering": true,
            "PagingType": 'simple',
            "processing": true,
            "serverSide": true,
            "autoWidth": false,
            "searchDelay": 1000,
            "order": [[6, "desc"]],
            "ajax": "/get_blog_datatable",
            "language": {
                "emptyTable": "No data available in table!!"
            },
            "columns": [
                {"data": "banner_image", render: show_image},
                {"data": "author__name"},
                {"data": "blog_type__name"},
                {"data": "name"},
                {"data": "is_approve", render:approve_button_show},
                {"data": "admin_user_id__username", render: admin_username},
                {"data": "create_dt",render: utc_to_date},
                {"data": "id", render: action_button},
            ]
        });
    });

    function show_image(data, type, row, meta) {
            if (data === "") {
                return '<center><img class="us bos" src="{% static 'backend/dist/img/no_user_image.png' %}" height="65px" width="65px"/></center>';
            } else {
                return '<center><img class="us bos" src="https://toneop.s3.ap-south-1.amazonaws.com/' + data + '"  height="65px" width="65px"/></center>';
            }
        }

    function admin_username(data, type, row, meta) {
        if (data === null) {
            return '-';
        } else {
            return data;
        }
    }

    function approve_button_show(data, type, row, meta) {
        if (data === true) {
            return '<button type="button" class="btn btn-secondary btn-sm is_approve" value="' + row['id'] + '" data-value="False"> <i class="fa fa-times">&nbsp;&nbsp;</i>Disapprove </button>';
        } else {
            return '<button type="button" class="btn btn-primary btn-sm is_approve" value="' + row['id'] + '" data-value="True"> <i class="fa fa-check">&nbsp;&nbsp;</i>Approve </button>';
        }
    }

    function action_button(data, type, row, meta) {
        return '<center><button type="button" class="btn btn-primary mr-2" onClick="Edit(' + row['id'] + ')" data-toggle="modal" data-target="#Edit-Model"><i class="fa fa-edit"></i></button><button type="button" class="btn btn-danger mr-2" onClick="Delete(' + row['id'] + ')" data-toggle="modal" data-target="#Delete-Model"><i class="fa fa-trash"></i></button></center>'
    }

    function utc_to_date(data, type, row, meta){
        return new Date(data).toString().slice(4, 24);
    }

</script>

<!-- Edit functionality -->
<script>
    function Edit(id) {
        console.log(id);
        if (id) {
            // Here we are calling ajax for filling data into edit expert type
            $.ajax({
                url: '/get_blog_ajax',
                type: 'post',
                async: false,
                cache: false,
                data: {
                    'id': id
                },
                success: function (data) {
                    $('#edit_id').val(data['id']);
                    $('#edit_blogname').val(data['name']);
                    $('#edit_blogdesc').val(data['description']);
                    $('#edit_bannerimage').val(data['banner_image']);
                    $('#edit_decriptionimage').val(data['description_image']);
                    $('#edit_blogtype').select2().val(data['blog_type']).trigger('change');
                    $('#edit_blogauthor').select2().val(data['author']).trigger('change');
                }
            });
        }
    }



</script>

<!-- Delete functionality -->
<script>
    function Delete(id) {
        if (id) {
            $('#delete_id').val(id);
        }
    }

</script>

<!-- Approve_Disapprove data using Ajax -->
<script>
    $('#approve_disapprove').on('submit', function (e) {
        e.preventDefault();
        $.ajax({
            url: '/approve_disapprove_blog',
            type: 'post',
            async: false,
            cache: false,
            data: {
                'approve_disapprove_id': $('#approve_disapprove_id').val(),
                'approve_disapprove_tag': $('#approve_disapprove_tag').val(),
            },
            success: function (data) {
                if (data['status'] === true) {
                    toastr.success(data['message']);
                    $('#Approve-Disapprove-Model').modal('hide');
                    $('#example1').DataTable().ajax.reload();
                } else {
                    toastr.error(data['message']);
                    $('#Approve-Disapprove-Model').modal('hide');
                    $('#example1').DataTable().ajax.reload();
                }
            }
        });
    })

    $(document).on('click', '.is_approve', function () {
        $('#approve_disapprove_tag').val($(this).data('value'));
        $('#approve_disapprove_id').val($(this).val());
        $('#Approve-Disapprove-Model').modal('show')
    })

</script>

{% endblock %}
